#!/bin/sh

set -e

output=$(env)
# set
echo "$output" > "${HOME}/${GITHUB_ACTION}.log"
echo "$output"

# Capture output
output="INFO >> Staring"
# Preserve output for consumption by downstream actions
echo "$output" > "${HOME}/${GITHUB_ACTION}.log"
echo "$output"

# Install grype
echo -e '"Package","Version Installed","Vulnerability ID","Severity"\n{{- range .Matches}}\n"{{.Artifact.Name}}","{{.Artifact.Version}}","{{.Vulnerability.ID}}","{{.Vulnerability.Severity}}"\n{{- end}}' > /tmp/CSV.tmpl 
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
grype version

output="INFO > CHECKING VULNERABILITY"
echo "$output" > "${HOME}/${GITHUB_ACTION}.log"
echo "$output"

if [ -z "$INPUT_SOURCE" ]; then
    echo "source is not set. Quitting."
    exit 1
fi

output="INFO > DIRECTORY TO CHECK $INPUT_SOURCE"
echo "$output" > "${HOME}/${GITHUB_ACTION}.log"
echo "$output"

# Starting analysis
grype dir:$INPUT_SOURCE -o template -t /tmp/CSV.tmpl > report.csv

output="INFO > END"
echo "$output" > "${HOME}/${GITHUB_ACTION}.log"
echo "$output"

output="INFO > exporting result file"
echo "$output" > "${HOME}/${GITHUB_ACTION}.log"
echo "$output"

# Return report content
cd /home
npm install
node index.js
